<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Taaspace.graph test</title>
  <link rel="stylesheet" href="lib/qunit-1.13.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="lib/qunit-1.13.0.js"></script>
  <script src="../taaspace-standalone.js"></script>
  <script type="text/javascript">
  
    // Fixture graphs
    
    // a -> b -> c -> d -> e
    //  \                 /
    //   --------<--------
    var alpha1 = {
      a: {name: 'a', next: 'b'},
      b: {name: 'b', next: 'c'},
      c: {name: 'c', next: 'd'},
      d: {name: 'd', next: 'e'},
      e: {name: 'e', next: 'a'}
    };
    
    //   b - c   g
    //  /     \ /
    // a       d
    //  \     / \
    //   e - f   h
    var fish = {
      a: ['b', 'e'],
      b: ['a', 'c'],
      c: ['b', 'd'],
      d: ['c', 'f', 'g', 'h'],
      e: ['a', 'f'],
      f: ['d', 'e'],
      g: ['d'],
      h: ['h']
    };
    
    asyncTest('basic graph usage', function () {
      expect(6); // 5 handler calls + 1 finish
      
      // Fixture alias
      var f = alpha1;
      
      Taaspace.graph.bfs({
        root: f.a,
        handler: function (vertex, spreadTo, end, predecessor, depth) {
          
          ok(depth < 5, 'Depth must be below 5 because' +
                        ' there are no more vertices.');
          
          setTimeout(function () {
            spreadTo([f[vertex.next]]);
          }, 50);
        },
        finish: function () {
          ok(true, 'The algorithm must call finish');
          
          start();
        }
      });
      
    });
    
    
    asyncTest('explicit end call', function () {
      
      var f = fish;
      
      Taaspace.graph.bfs({
        root: f.a, // Start from the mouth of fish.
        handler: function (v, spreadTo, end, predecessor, depth) {
          
          // End to the tail of fish.
          if (v.length === 1) {
            end(v);
          } else {
            setTimeout(function () {
              // Convert strings to vertices and spread to those.
              var i, nextOnes;
              nextOnes = [];
              for (i = 0; i < v.length; i += 1) {
                nextOnes.push(f[v[i]]);
              }
              spreadTo(nextOnes);
            }, 50);
          }
        },
        finish: function (endvertex) {
          ok(typeof endvertex !== 'undefined', 'Endvertex not found.');
          ok(endvertex[0] === 'd', 'Endvertex is not g.');
          
          // Finish
          start();
        }
      });
    });
    
    
    asyncTest('Not calling spreadTo or end', function () {
      var f = fish;
      Taaspace.graph.bfs({
        root: f.a,
        handler: function (v, spreadTo, end) {
          ok(true, 'Hander is called');
          start();
        },
        finish: function (endvertex) {
          ok(false, 'We should not be here.');
        }
      });
    });
    
    
    asyncTest('Call spreadTo with invalid array.', function () {
      var f = fish;
      Taaspace.graph.bfs({
        root: f.a,
        handler: function (v, spreadTo, end) {
          try {
            spreadTo({not:'an array'});
          } catch (err) {
            ok(err.name === 'InvalidArrayError',
               'Should throw InvalidArrayError');
            start();
          }
        },
        finish: function (endvertex) {
          ok(false, 'We should not be here.');
        }
      });
    });
    
    
    asyncTest('Call end with number of parameters.', function () {
      var f = fish;
      Taaspace.graph.bfs({
        root: f.a,
        handler: function (v, spreadTo, end) {
          end('h', 'e', 'll', 'o');
        },
        finish: function (a, b, c, d) {
          ok(a+b+c+d === 'hello', 'Finish should have four parameters ' +
                                  'which form \'hello\'.');
          start();
        }
      });
    });
    
    /* Ready for future
    asyncTest('', function () {
    });
    
    asyncTest('', function () {
    });
    
    asyncTest('', function () {
    });*/
    
  </script>
</body>
</html>
