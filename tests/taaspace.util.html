<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Taaspace.util.mapReduce test</title>
  <link rel="stylesheet" href="lib/qunit-1.13.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="lib/qunit-1.13.0.js"></script>
  <script src="../taaspace-standalone.js"></script>
  <script type="text/javascript">
    
    // Unit alias
    var mapReduce = Taaspace.util.mapReduce;
    
    // For randomized delays
    var randomMinMax = function (min, max) {
      return Math.random() * (max - min) + min;
    };
    
    // Test fixtures
    var hello = ['h', 'e', 'll', 'o'];
    
    
    
    asyncTest('basics', function () {
      mapReduce(
        hello,
        function map(x, done, index, array) {
          ok(array[index] === x, 'Array should contain x in the index.');
          var delay = Math.round(randomMinMax(10, 100));
          setTimeout(function () {
            done(index, x);
          }, delay);
        },
        function reduce(resultArray) {
          
          ok(resultArray.join('') === 'hello',
             'Joined array should result \'hello\'');
          
          // Next test
          start();
        }
      );
    });
    
    asyncTest('empty array as a domain', function () {
      mapReduce(
        [],
        function map(x, done, index, array) {
          ok(false, 'This should not be executed');
        },
        function reduce(resultArray) {
          ok(typeof resultArray === 'object',
             'Result should be array.');
          ok(resultArray.length === 0,
             'Result array should be empty.');
          // Next test
          start();
        }
      );
    });
    
    asyncTest('Invalid params', function () {
      // Invalid params
      try {
        mapReduce(
          3,
          function map(x, done, index, array) {
            ok(false, 'This should not be executed');
          },
          function reduce(resultArray) {
            ok(false, 'This should not be executed');
          }
        );
      } catch (err) {
        ok(err.name === 'InvalidParameterError',
               'Unexpected exception name');
        
        // Next test
        start();
      }
    });
    
    asyncTest('Array with one item', function () {
      mapReduce(
        [2],
        function map(x, done, index, array) {
          ok(x === 2, 'Element should be 2.');
          ok(index === 0, 'Index should be 0.');
          ok(array.length === 1, 'Array length should be 1.');
          
          done(index, x);
        },
        function reduce(resultArray) {
          ok(resultArray.length === 1, 'Result array length should be 1.');
          ok(resultArray[0] === 2, 'Result array should contain 2.');
          
          // Next test
          start();
        }
      );
    });
    
    asyncTest('What happens if done is not called.', function () {
      var maps = 0;
      mapReduce(
        [1, 2, 3],
        function map(x, done, index, array) {
          maps += 1;
        },
        function reduce(resultArray) {
          ok(false, 'Reduce should not be called');
        }
      );
      setTimeout(function wait() {
        ok(maps === 3, 'Map function should be called three times');
        // Next test
        start();
      }, 50);
    });
    
    /*
    asyncTest('', function () {
    });
    */
    
  </script>
</body>
</html>
